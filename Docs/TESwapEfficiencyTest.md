# Experiment - TE Swap Efficiency Test #

This experiment scenario tests that Helix's TE algorithm correctly modifies
paths to reduce usage on congested ports. This scenario was initially used in
conjunction with the group port swap based TE optimisation methods, however,
it also applies to the default CSPF re-computation approach. This scenario was
converted into a set of tests (please see "Testing" section of main repository
read me for more information). For the description of the expected result, we
assume that the candidates are considered in ascending order
(`candidate_sort_rev = False`). If not specified otherwise, the expected result
is discussed in terms of the FirstSol TE optimisation methods that iterate
through every port on the active primary path and finds/applies the first
appropriate group modifications (swaps) to generate a new path that avoids the
congested port.

This experiment uses the `Networks/TETestTopo.py` topology module:

![TETestTopo.png Image](/Networks/Diagram/TETestTopo.png)



## Helix's TE Algorithm Behaviour ##

Helix's TE algorithm is bi-directional, detecting and resolving congestion
based on traffic flow on a link (ends of a link or ports). For example, we
have two nodes (A and B) connected by a link (L) which has two
ports/flow-directions (a' and b').

```
+---+           L          +---+
| A |--(a')----------(b')--| B |
+---+                      +---+
```

Helix's TE algorithm considers the two link directions as independent such that
traffic generated by A on port a' going to B via port b' is different to
traffic flowing from B on b' to A via a'. Essentially, Helix's TE algorithm
optimises port congestion based on transmission (egress) rates. If A sends
X Mbps packets to B such that X > L's capacity (or X exceeds the TE threshold),
Helix will consider b' as congested and will resolve the congestion by reducing
traffic being sent to b'.



## Test Description ##

To test that Helix's TE algorithm behaves correctly and the bi-directional
detection works as expected (i.e. both directions of a link are optimised and
link traffic directions are independent), we define several scenarios. If not
specified, the links on the topology are configured to 1Gbps. All path pairs
will use the link segments s1-s2-s3 as the primary path and s1-s4-s2-s5-s3 as
the secondary path.

In this test, we modify the capacity of three links which we label as follows:
    * s1-s2 we assign label A
    * s2-s3 we assign label B
    * s5-s3 we assign label C


### Scenario 1 ###

* A is set to 200Mbps
* H1 sends 150Mbps to H3
* H2 sends 120Mbps to H4
* Helix detects that A is congested

Helix will modify H2-H4 to use the path S1-S4-S2-S3 (swap group ports on S1).
H1-H3 still uses the s1-s2-s3 path (no changes).

_Candidate reverse sort flag set to True:_
Helix will modify H1-H3 to use the path S1-S4-S2-S3 (modify group ports on S1).
H2-H4 still uses the s1-s2-s3 path.


### Scenario 2 ###

* A and B are set to 200Mbps
* Same traffic send rates as Scenario 1
* Helix detects that A and B are congested

Helix will modify H2-H4 to use path S1-S4-S2-S5-S3 (modify ports on S1 and S2)
to resolve congestion on both A and B. H1-H3 still uses the primary path.

_Candidate reverse sort flag set to True:_
We observe the same path as we did when the flag is false (consider candidates
in ascending order), however, the path modification now applies to H1-H3 and
H2-H4 will remain unchanged.


### Scenario 3/3a ###

This scenario checks for path flapping. Helix deploys mechanisms to prevent
traffic to be shifted back and forth between ports by checking and discarding
any path changes that introduce new congestion. Helix does, however, provide
mechanisms that allow for partial solutions (partial solution flag), which will
accept a partial fix as long as: no packet loss occurs and the new congestion
rate is lower than the previous observed rate (the solution decreases congestion
in the network).

* A and B are set to 200 Mbps. C is set to 100 Mbps.
* Same traffic rates as the previous scenarios
* Helix detects that A and B are congested

For this scenario, the swap port methods will provide a partial solution. Helix
will modify H2-H4 to use S1-S4-S2-S3, resolving the detected congestion on A.
When proceeding to fix B, Helix will fail to resolve the detected congestion as
neither candidates can be moved to the alternative path (S2-S5-S3) because C
does not have sufficient capacity. For this scenario, Helix will swap the
group ports of H2-H4 at S1 but fail to resolve congestion on B.

Even though Helix's TE optimisation algorithm performs checks to invalidate a
potential path change if it introduces new congestion, the swap at S1 is
accepted as the congestion encountered is on an existing port from the current
candidate path. In other words, the method will only discard a potential path
if a new link in that potential path (not part of the current candidate path)
cannot carry the candidate's traffic (new congestion introduced). The
assumption of the algorithm is that if we have non-unique link which is
congested, this will be fixed during the current TE optimisation operation.
In other words, Helix will have two ports that are congested (A and B for this
scenario) in its congested port list and will attempt to address congestion for
both.

_Candidate reverse sort flag set to True:_ We expect to see the same behaviour
as above, however, H3-H4 is modified and H2-H4 is not.


### Scenario 4 ####

* A is set to 100Mbps and B to 200Mbps (note C is set back to 1Gbps)
* Same traffic rates as previous scenarios
* A and B are congested

Because both H2-H4 and H1-H3 send traffic that exceeds A's capacity, Helix will
modify both candidates to avoid using A (modify ports of group table on S1).
H2-H4 will also be modified to avoid using B (swap ports on S2). H1-H3 will
end up using the S1-S4-S2-S3 path, H2-H4 the S1-S4-S2-S5-S3 path.

_Candidate reverse sort flag set to True:_
We expect to observe similar behaviour, however, Helix modifies H1-H3 (heavy
hitter) to avoid both ports while H2-S4 will only avoid A.


### Scenario 5 ###

* A is set to 200Mbps and B to 100Mbps
* Same traffic rates as previous scenario
* A and B are congested

Similar to scenario 4, Helix will modify both candidates to avoid using B as
they generate more traffic than B's capacity. We expect that H1-H3 will use
the S1-S2-S5-S3 path, while H2-H4 the S1-S4-S2-S5-S3.

_Candidate reverse sort flag set to True:_
We expect the same behaviour outlined in scenario 4: H1-H3 will be modified to
avoid using both A and B while H2-H4 will only avoid B.


### Scenario 6 ###

* A and B are set to 100Mbps
* Same traffic as previous scenarios
* A and B are congested.

Helix will modify both candidates (H1-H3 and H2-H4) to use their secondary
paths (swap at S1 and S2) such that they avoid using both A and B. Both
candidates paths are modified to S1-S4-S2-S5-S3.

_Candidate reverse sort flag set to True:_ Same result as above!


### Scenario 7 ###

* A and B are set to 100Mbps
* H1 sends 150Mbps to H3 (H2 no longer sends packets to H4)
* A and B are congested.

We expect to observe the same result as scenario 6, however, only H1-H3 is
modified as H2 does not send any traffic to H4 (not modified as not a candidate
of either A or B -> does not use the ports).


### Scenario 8 ###

* H1 sends 150Mbps to H3
* H4 sends 120Mbps to H2
* A and B are set to 200Mbps.

No path changes will occur as the two streams of traffic are flowing in
opposite directions. H1-H3 uses S1-S2-S3 and H4-H2 uses S3-S2-S1. This scenario
ensures Helix correctly identifies the primary paths of the candidates and
collected statics are bi-directional.


### Scenario 9 ###

* A and B are set to 100Mbps
* Same traffic as scenario 8.
* A and B are congested

Because both candidates (regardless of travel direction on congested links)
send more traffic than the constrained links capacity, Helix will modify both
paths to avoid using A and B. H1-H3 will be modified to use S1-S4-S2-S5-S3
(port swaps occur at S1 and S2) and H4-H2 will use S3-S5-S2-S4-S1 (swaps occur
at S3 and S2).

_Candidate reverse sort flag set to True:_ Same result as above!


### Scenario 10 ###

* H1 sends 1Gbps to H2
* H3 sends 1Gbps to H4

H1-H2 are adjacent so traffic flows from H1 to H2 via S1.
H3-H4 are adjacent as well, traffic flows from H3 to H4 via S3.

In this scenario, the two ports used by the candidates are ingress/egress ports
(special ports that lead to hosts). Helix will not optimise these ports as we
have no control over which link the hosts send traffic. No congestion will be
detected or path changes will occur for this scenario. This scenario was
created to ensure that Helix does not try to optimise ingress/egress links
leading to host nodes.


### Scenario 11 ###

* A, B and C are set to 1Gbps
* All links leading to host nodes are constrained to 100Mbps
* H1 sends 150Mbps to H3
* H2 sends 150Mbps to H4

Similar to scenario 10, Helix will not optimise the host ingress/egress links
so no congestion is reported or path modifications occur.


### Scenario 12 ###

* Same constraints as scenario 11
* H1 sends 150Mbps to H4
* H2 sends 150Mbps to H3

We should see the same result as scenario 11 (no congestion detect and no path
changes occur).



## CSPFRecomp TE Optimisation Method Expected Results ##

When using the CSPF re-computation TE optimisation method (preferred method for
Helix), the expected results are the same as outlined above (swap method). A
key difference between the CSPF re-computation and swap-over methods is that
the CSPF re-computation will perform a single path change while the swap-over
methods make take more than one step (i.e. swap at S1 first then swap at S2)
implying that two path modifications will occur. For example, for scenario 6
the CSPF re-computation method will implicitly fix congestion on both A and B
when resolving congestion on A as the new path will avoid using both ports.
When the algorithm moves to the next congested port (i.e. B), it will see that
the port is no longer congested. Functionally, both methods produce the same
amount of path changes as the first swap at S1 and the second swap at S2 will
affect the same number of switches.

For scenario 3/3a, when using the CSPF re-computation method, we expect that
Helix will fail to optimise any paths as the algorithm detects that both B and
C do not have sufficient capacity to carry the candidate traffic. The swap-over
methods will accept the first group change at S1 as they only check if unique
nodes in the new path produced by modifying a group port, is congested. In this
case, S2-S3 is part of the old path so it is not checked but when resolving
congestion on B, no valid solution to resolve congestion is found (i.e. a
partial fix).


We expect that the results using the CSPFRecomp method are the same as the
FirstSol results outlined above. When using the CSPFRecomp TE optimisation
method and sorting candidates in ascending orders (candidate reverse sort is
False), we expect to see the following results for the 12 scenarios defined
in this test:

* Scenario 1: H2-H4 is modified to S1-S4-S2-S3
* Scenario 2: H2-H4 is modified to S1-S4-S2-S5-S3
* Scenario 3/3a: No path re-computation occurs (no solution found)
* Scenario 4: H2-H4 is modified to S1-S4-S2-S5-S3, H1-H3 to S1-S4-S2-S3.
* Scenario 5: H2-H4 is modified to S1-S4-S2-S5-S3, H1-H3 to S1-S2-S5-S3.
* Scenario 6: Both H1-H3 and H2-H4 are modified to S1-S4-S2-S5-S3.
* Scenario 7: H1-H3 is modified to S1-S4-S2-S5-S3
* Scenario 8: No change as no congestion occurs
* Scenario 9: H1-H3 is modified to S1-S4-S2-S5-S3, H4-H2 to S3-S5-S2-S4-S1
* Scenario 10: No path modifications as no congestion occurs
* Scenario 11: Ingress constrained. No path changes occur.
* Scenario 12: Same result as scenario 11.


When sorting candidates in descending order (candidate reverse sort flag is
True), we should see the same results as before but the affected candidate
which is modified first changes such that the candidate generating the most
traffic is optimised first. For example, in scenario 1 H1-H3 will be modified
instead of H2-H4.
